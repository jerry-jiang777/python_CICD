name: Python CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª æ‰§è¡Œæµ‹è¯•å¹¶ç”Ÿæˆ Allure ç»“æœ
        run: |
          pytest tests/ --alluredir=allure-results

      - name: ğŸ§µ æ‰“åŒ… Allure æµ‹è¯•æŠ¥å‘Š
        if: always()
        run: zip -r allure-report.zip allure-results

      - name: ğŸ’¾ ä¸Šä¼  Allure æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report.zip

      - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥ (flake8)
        run: flake8 . --max-line-length=120

      - name: ğŸ”” ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆå¤±è´¥æ—¶è§¦å‘ï¼‰
        if: failure()
        uses: xuexb/qy-wechat-robot-action@v1
        with:
          content: |
            âŒ æµ‹è¯•å¤±è´¥ï¼
            Repo: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
          webhook: ${{ secrets.WEBHOOK_URL }}

      - name: ğŸ“§ é‚®ä»¶é€šçŸ¥ï¼ˆå¤±è´¥æ—¶å‘é€ï¼‰
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ğŸš¨ é¡¹ç›®æµ‹è¯•å¤±è´¥æŠ¥å‘Š
          body: |
            ä»“åº“ï¼š${{ github.repository }}
            åˆ†æ”¯ï¼š${{ github.ref }}
            æäº¤ï¼š${{ github.sha }}
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Action
